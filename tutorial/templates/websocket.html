{% extends 'base.html' %}

{% block content %}
<div class="container">
    <h1>Autores Externos en Tiempo Real</h1>

    <div class="lista-container">
        <h3>Lista de Autores</h3>
        <ul id="lista-autores"></ul>
    </div>
</div>

<script>
    const WS_URL = 'ws://192.168.1.86:8000/ws/test/';
    let socket;
    let isConnected = false;

    function connectWebSocket() {
        if (!isConnected) {
            socket = new WebSocket(WS_URL);
            
            socket.onopen = function() {
                console.log('Conectado al servidor de autores');
                isConnected = true;
                socket.send(JSON.stringify({
                    type: 'get_autores'
                }));
            };
            
            socket.onmessage = function(event) {
                try {
                    const data = JSON.parse(event.data);
                    console.log('Datos recibidos:', data);
                    if (data.message && Array.isArray(data.message)) {
                        actualizarListaAutores(data.message);
                    }
                } catch (error) {
                    console.error('Error procesando mensaje:', error);
                }
            };
            
            socket.onclose = function() {
                console.log('Desconectado del servidor de autores');
                isConnected = false;
                setTimeout(connectWebSocket, 8000);
            };

            socket.onerror = function(error) {
                console.error('Error en la conexiÃ³n:', error);
            };
        }
    }

    function actualizarListaAutores(autores) {
        const listaAutores = document.getElementById('lista-autores');
        listaAutores.innerHTML = ''; // Limpiar lista actual
        
        console.log('Actualizando lista con autores:', autores);

        autores.forEach(autor => {
            const li = document.createElement('li');
            li.className = 'autor-item';
            li.innerHTML = `
                <div class="autor-info">
                    <h4>${autor.nombre} ${autor.apellido}</h4>
                    <div class="autor-detalles">
                        <p><strong>ID:</strong> ${autor.id}</p>
                        <p><strong>Nombre:</strong> ${autor.nombre}</p>
                        <p><strong>Apellido:</strong> ${autor.apellido}</p>
                    </div>
                </div>
            `;
            listaAutores.appendChild(li);
            console.log('Autor agregado:', autor);
        });
    }

    document.addEventListener('DOMContentLoaded', function() {
        connectWebSocket();
    });
</script>

<style>
    .container {
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
        font-family: Arial, sans-serif;
    }

    h1 {
        color: #333;
        text-align: center;
        margin-bottom: 30px;
    }

    .lista-container {
        background-color: #f5f5f5;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .lista-container h3 {
        color: #2196F3;
        margin-bottom: 20px;
    }

    #lista-autores {
        list-style: none;
        padding: 0;
    }

    .autor-item {
        background-color: white;
        padding: 20px;
        margin-bottom: 15px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        transition: transform 0.2s;
    }

    .autor-item:hover {
        transform: translateY(-2px);
    }

    .autor-info h4 {
        margin: 0 0 15px 0;
        color: #1976D2;
        font-size: 1.2em;
    }

    .autor-detalles {
        padding-left: 15px;
        border-left: 3px solid #2196F3;
    }

    .autor-detalles p {
        margin: 8px 0;
        color: #666;
    }

    .autor-detalles strong {
        color: #333;
        margin-right: 5px;
    }

    .loading {
        text-align: center;
        padding: 20px;
        color: #666;
    }
</style>
{% endblock %}